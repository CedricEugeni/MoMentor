# MoMentor - Copilot Instructions

## Project Overview

MoMentor is a momentum investing strategy mentor web application for US stocks. It provides automated monthly portfolio recommendations using a momentum-based algorithm, with features for tracking performance and managing rebalancing.

## Architecture

### Tech Stack

- **Frontend**: React 18 + TypeScript + Vite + TailwindCSS + shadcn/ui
- **Backend**: Python 3.11 + FastAPI + SQLAlchemy
- **Database**: SQLite (local, Docker volume)
- **Scheduling**: APScheduler (cron for monthly runs)
- **Market Data**: Yahoo Finance API (yfinance library, rate-limited at times)
- **Deployment**: Docker Compose

### Project Structure

```
/backend
  /app
    /algo          - Momentum strategy implementations
    /models.py     - SQLAlchemy ORM models
    /routes        - FastAPI route handlers
    /services      - Business logic layer
    /scheduler.py  - APScheduler configuration
    /main.py       - FastAPI app entry point

/frontend
  /src
    /components    - Reusable UI components (shadcn/ui)
    /pages         - Route pages (Dashboard, Runs, Portfolio, Settings)
    /lib           - Utilities (API client, localStorage, utils)
```

## Coding Conventions

### Python (Backend)

1. **Type Hints**: Always use type hints for function parameters and returns

   ```python
   def get_allocations(capital_usd: Decimal, run_date: date) -> List[Allocation]:
   ```

2. **Decimal for Money**: NEVER use `float` for monetary values, always use `Decimal`

   ```python
   from decimal import Decimal
   capital = Decimal("10000.00")  # ✅ Correct
   capital = 10000.00              # ❌ Wrong
   ```

3. **SQLAlchemy Models**: Use declarative base, define relationships properly

   ```python
   class AlgorithmRun(Base):
       __tablename__ = "algorithm_runs"
       # ... columns ...
       recommended_allocations = relationship("RecommendedAllocation", back_populates="run")
   ```

4. **Service Layer**: Business logic goes in `/services`, not in routes
   - Routes handle HTTP requests/responses
   - Services contain business logic
   - Models are just data structures

5. **Error Handling**: Use custom exceptions and handle them in routes
   ```python
   class MarketDataUnavailableError(Exception):
       pass
   ```

### TypeScript (Frontend)

1. **Strict Mode**: Always enabled, no `any` types unless absolutely necessary

   ```typescript
   // ✅ Correct
   const formatCurrency = (value: number): string => {};

   // ❌ Avoid
   const formatCurrency = (value: any) => {};
   ```

2. **API Client**: Centralized in `/lib/api.ts` with proper typing

   ```typescript
   export interface AlgorithmRun {
     id: number;
     run_date: string;
     // ...
   }
   ```

3. **React Query**: Use for all API calls, proper cache invalidation

   ```typescript
   const { data } = useQuery({
     queryKey: ["runs"],
     queryFn: listRuns,
   });
   ```

4. **Component Structure**: Functional components with hooks

   ```typescript
   export default function Dashboard() {
     const [state, setState] = useState<Type>(initial);
     // ...
   }
   ```

5. **Styling**: Use TailwindCSS classes, shadcn/ui components, `cn()` utility for conditional classes
   ```typescript
   <div className={cn("base-class", isActive && "active-class")}>
   ```

## Database Schema

### Key Tables

1. **algorithm_runs**: Main table for each algorithm execution
   - `status`: 'pending' (waiting for confirmation) or 'completed'
   - `trigger_type`: 'auto', 'manual', or 'test'

2. **recommended_allocations**: Target allocations from algorithm

3. **optimized_moves_cashflow**: Sell-then-buy moves (ordered)

4. **optimized_moves_swaps**: Direct swap moves (minimized transactions)

5. **actual_positions**: User-confirmed positions after executing trades
   - `first_validation_date`: When user first confirmed (used for P&L calculation)

6. **actual_cash**: Uninvested cash confirmed by user

7. **price_cache**: Cached stock prices (fallback when Yahoo Finance unavailable)

### Important Patterns

- Always use `run_id` foreign keys to link data to runs
- Use `Decimal` columns for all monetary values (precision=15, scale=2)
- Use `DateTime` with UTC for all timestamps
- Relationships use `back_populates` for bidirectional access

## Business Logic

### Algorithm Workflow

1. **Generation** (monthly auto or manual trigger):
   - Calculate current capital (from last confirmed positions + live prices)
   - Run momentum strategy algorithm
   - Generate recommended allocations
   - Calculate two types of rebalancing moves:
     - **Cashflow**: All sells first (free cash), then all buys
     - **Swaps**: Match sells with buys directly (greedy algorithm)
   - Create new run with `status='pending'`

2. **Position Confirmation**:
   - User enters actual shares and prices paid
   - System validates (warn if >10% discrepancy from recommended capital)
   - Attempts to fetch live prices from Yahoo Finance
   - If Yahoo unavailable:
     - Save to localStorage with 14-day expiration
     - Return error, allow retry later or force confirm
   - If successful or force confirmed:
     - Save to `actual_positions` and `actual_cash` with `first_validation_date`
     - Change run `status='completed'`
     - Clear localStorage

3. **Portfolio Tracking**:
   - Fetch live prices for all positions
   - Calculate P&L: (current_value - entry_value) since `first_validation_date`
   - Display per-position and total P&L

### Rebalancing Algorithms

**Cashflow Strategy** (`calculate_cashflow_moves`):

```python
# Phase 1: SELL moves (order_index 1-N)
for position in current that needs to be reduced or eliminated:
    create SELL move with order_index++

# Phase 2: BUY moves (order_index N+1-M)
for position in target that needs to be increased or created:
    create BUY move with order_index++
```

**Swap Strategy** (`calculate_swap_moves`):

```python
# Identify excess (to sell) and deficit (to buy)
# Sort by value (greedy: match largest first)
# Match excess with deficit
for each excess:
    if deficit available:
        create swap move (from_symbol → to_symbol)
    else:
        create pure sell move
# Handle remaining deficit as pure buys
```

### localStorage Strategy

- **Key**: `momentor_pending_confirmation_{runId}`
- **Expiration**: 14 days
- **Cleanup**: On app mount, remove expired entries
- **Use Case**: Save user input when Yahoo Finance is unavailable, allow retry

## API Endpoints

### Runs

- `POST /api/runs/generate` - Generate new run
- `GET /api/runs` - List all runs
- `GET /api/runs/{id}/details` - Get run details with all related data
- `POST /api/runs/{id}/confirm-positions` - Confirm actual positions
- `GET /api/runs/has-pending` - Check if any pending runs (for badge)

### Portfolio

- `GET /api/portfolio/current` - Current portfolio with live prices and P&L

### System

- `POST /api/reset` - Delete all data

## UI/UX Patterns

### Navigation

- Header with navigation links
- "Runs & Rebalancing" link shows red dot badge when `has_pending=true`

### Pages

1. **Dashboard**: Generate new run (manual or test mode)
2. **Runs**: List all runs, click to view details
3. **Run Details**: Tabs for recommendations, cashflow moves, swaps, actual positions
4. **Portfolio**: Current positions with live P&L
5. **Settings**: About, usage tips, reset data

### Colors

- **Green**: Positive P&L, BUY actions
- **Red**: Negative P&L, SELL actions, destructive actions
- **Orange**: Warnings, pending status
- **Blue**: Primary actions, links

### User Flows

**First-time user**:

1. Dashboard → Enter capital → Generate
2. View recommendations and moves
3. Execute trades with broker
4. Confirm actual positions
5. View portfolio with P&L

**Monthly user**:

1. Automatic run on 1st at 11:00
2. See red badge on "Runs & Rebalancing"
3. Click to view pending run
4. Review and execute
5. Confirm positions

## Testing Strategy

### Manual Testing

- Use "Test Mode" to generate runs without affecting monthly workflow
- Test with various capital amounts
- Test position confirmation with warnings (>10% discrepancy)
- Test market data unavailable scenario (disconnect network)
- Test localStorage persistence and expiration

### Key Scenarios

1. First run with no prior data
2. Monthly automatic run
3. Position confirmation with exact amounts
4. Position confirmation with discrepancy
5. Yahoo Finance unavailable during confirmation
6. Retry after Yahoo Finance becomes available
7. Portfolio view with multiple positions
8. Reset all data

## Common Tasks

### Adding a New Stock Symbol

- Just add it to the algorithm's allocation list
- System will automatically fetch prices and calculate moves

### Modifying the Algorithm

- Edit `/backend/app/algo/strategy.py`
- Implement `MomentumStrategy` interface
- Return `List[Allocation]` with symbols and percentages (must sum to ~1.0)
- Update `get_strategy()` factory function

### Adding a New API Endpoint

1. Create route in `/backend/app/routes/`
2. Add to router in `/backend/app/main.py`
3. Create API function in `/frontend/src/lib/api.ts`
4. Add TypeScript types
5. Use with React Query in components

### Adding a New Page

1. Create page in `/frontend/src/pages/`
2. Add route in `/frontend/src/main.tsx`
3. Add navigation link in `/frontend/src/components/Layout.tsx`

## Environment Variables

### Backend

- `DATABASE_URL`: SQLite connection string
- `ENABLE_AUTO_SCHEDULING`: Enable/disable monthly cron
- `TZ`: Timezone for scheduler (Europe/Paris)

### Frontend

- `VITE_API_URL`: Backend API URL (default: http://localhost:8000)

## Deployment

### Local Development

```bash
npm run dev              # Start Docker Compose (frontend + backend)
```

### Ports

- Frontend: http://localhost:3000
- Backend: http://localhost:8000
- Health: http://localhost:8000/health

### Production (Docker)

```bash
npm start                # Build and start containers
```

### Data Persistence

- Database stored in Docker volume `momentor_database_data`
- Persists across container restarts
- Delete with `npm run reset-data`

## Important Reminders

1. ⚠️ **Never use `float` for money** - always `Decimal`
2. ⚠️ **Always type hint in Python** - helps catch bugs early
3. ⚠️ **Invalidate React Query cache** after mutations
4. ⚠️ **Handle Yahoo Finance errors gracefully** - it's a free API, it can fail; force confirm is allowed
5. ⚠️ **Use `first_validation_date` for P&L** - not `run_date`
6. ⚠️ **Test with real price fluctuations** - use different symbols, not just AAPL
7. ⚠️ **Remember localStorage expiration** - 14 days cleanup

## Future Enhancements Ideas

- Multi-user authentication
- Multiple portfolio support
- Currency conversion (EUR, GBP, etc.)
- Email notifications for monthly runs
- Export data to CSV
- Backtesting framework
- More sophisticated rebalancing (tax-loss harvesting)
- Integration with broker APIs
- Mobile responsive improvements
- Dark mode
- Chart visualizations for P&L trends
